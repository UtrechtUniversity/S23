# Day 2: Latent Growth Models

```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(MplusAutomation)
library(tidySEM)
show_answers <- TRUE
knitr::opts_chunk$set(warning = FALSE, message = FALSE, results = "hide", eval = show_answers, echo = show_answers)
options(digits = 2)
# f <- list.files(pattern = "(inp|out|log|dat|gh5)$")
# f <- f[!f %in% c("DatingSex.dat", "DDS8_1.dat", "PTSD.dat")]
# file.remove(f)
```

This computer lab session demonstrates to run latent growth models in batch, using the R-package `MplusAutomation`.
Note that, if you do not want to automate part of your workflow (like making plots and tables), you can also use Mplus exclusively.
All of the input files for the exercises described in this GitBook are provided with the course materials.

To get started with today's computer lab, first open the project file called "S23.Rproj". It should load in the program "RStudio". The bottom right panel has several tabs, including one called "Files". Click on "Files" in this bottom right tab, and click the file "growth_exercises.R". 

## Exercise 1: burn survivors 
 
The file “PTSD.dat” contains another data set on burn survivors.
An incomplete, basic Mplus syntax can be found in the file 
“PTSD - M0.inp”.

Specifying that same syntax could be done in R, using `MplusAutomation`, as well. 
First, load the file `PTSD.dat` into the R environment. 
For convenience's sake, rename the columns of the data object to something a human would understand:

```{r read_dataptsd, echo = TRUE, eval = TRUE}
data <- read.table("PTSD.dat", na.strings = -999)
names(data) <- c("gender", "tvlo",
                 "W1", "W2", "W3", "W4", "W5", "W6", "W7", "W8",
                 "pain")
```

To specify a basic, *incomplete* syntax, use:

```{r, echo = TRUE, eval = TRUE}
basic <- mplusObject(
  TITLE = "exercise 1",
  MODEL = "",
  OUTPUT = "standardized;",
  PLOT = "SERIES = w1-w8 (s);
          TYPE = PLOT3;",
  rdata = data,
  usevariables =
    c("W1", "W2", "W3", "W4", "W5", "W6", "W7", "W8")
)
```

To evaluate this model, you can use:

```{r, echo = TRUE, eval = FALSE}
result <- mplusModeler(basic, modelout = "basic.inp", run = 1L)
```

To summarize the results, you can use:

```{r, echo = TRUE, eval = FALSE}
# For one model
SummaryTable(result)
# For more models
SummaryTable(list(result1, result2))
```

### Exercise 1a

Specify a latent growth model. Consider different specifications discussed in the lecture, and try to find the best specification.

Use only the time measurements, not including additional 
predictor variables.  
Think about: 

* which metric of time to use (see the SPSS file form more information about the variables); 
* the shape of the function (linear or quadratic); 
and base your decision of the best model on:   
* model fit indices; 
* model comparison tools; 
* plots; 
* interpretation of the model parameters. 

<details>
  <summary><b>Click to show answers</b></summary>

Here is an example of how to approach the problem:

```{r}
# First, create a linear model from the basic one
linear <- basic
linear$MODEL <-
  "i s | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_linear <- 
  mplusModeler(linear, modelout = "linear.inp", run = 1L)
# Then, a quadratic one
quad <- basic
quad$MODEL <-
  "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_quad <-
  mplusModeler(quad, modelout = "quad.inp", run = 1L)
# Then, a quadratic one with fixed variance
quad0 <- basic
quad0$MODEL <-
  "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;
   q@0;"
result_quad0 <-
  mplusModeler(quad0, modelout = "quad0.inp", run = 1L)
# Combine them both in a list:
results <- list(result_linear, result_quad, result_quad0)
# Compare the fit:
SummaryTable(results,
             keepCols = c("Filename", "Parameters",
                          "AIC", "BIC", "RMSEA_Estimate",
                          "CFI", "TLI", "SRMR"))
``` 

```{r, results = "asis", echo = FALSE}
# First, create a linear model from the basic one
invisible({
linear <- basic
linear$MODEL <- "i s | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_linear <- mplusModeler(linear, modelout = "linear.inp", run = 1L)
# Then, a quadratic one
quad <- basic
quad$MODEL <- "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_quad <- mplusModeler(quad, modelout = "quad.inp", run = 1L)
# Then, a quadratic one with fixed variance
quad0 <- basic
quad0$MODEL <- "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;
               q@0;"
result_quad0 <- mplusModeler(quad0, modelout = "quad0.inp", run = 1L)
# Combine them both in a list:
results <- list(result_linear, result_quad, result_quad0)
})
kbl(SummaryTable(results, keepCols = c("Filename", "Parameters", "AIC", "BIC", "RMSEA_Estimate", "CFI", "TLI", "SRMR")), digits = 2)
```

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 1b: Add covariates

Using the best fitting LGM model found above, regress the growth parameters on TVLO and regress Pain 
on the growth parameters (see example from slides).
Are there gender differences in the regression of the 
growth parameters on TVLO and in the regression of Pain on the growth parameters?

<details>
  <summary><b>Click to show answers</b></summary>

```{r}
# Assuming quad0 was the best, start with that
covs <- quad0
# Add to the existing model
covs$MODEL <- c(covs$MODEL,
                "
                i s on TVLO;
                pain on i s; 
                MODEL male:
                i on TVLO (m1);
                s on TVLO (m2);
                pain on i (m3);
                pain on s (m4);
                MODEL female:
                i on TVLO (f1);
                s on TVLO (f2);
                pain on i (f3);
                pain on s (f4);")
# Add new usevariables:
covs$usevariables <- c(covs$usevariables,
                       "tvlo", "gender", "pain")
covs$rdata
# Add grouping variable:
covs$VARIABLE <- "GROUPING IS gender (1 = male 2 = female);"
# Add parameter tests
covs$MODELTEST <- "m3 = f3; m4 = f4;"
                
result_covs <- mplusModeler(covs,
                            modelout = "covs.inp",
                            run = 1L)
# Obtain the model summaries; you need the Wald test for
# the parameter difference tests.
get_summaries(result_covs)
```
```{r, echo = FALSE, eval = TRUE, results='hide'}
invisible({
  linear <- basic
linear$MODEL <- "i s | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_linear <- mplusModeler(linear, modelout = "linear.inp", run = 1L)
# Then, a quadratic one
quad <- basic
quad$MODEL <- "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;"
result_quad <- mplusModeler(quad, modelout = "quad.inp", run = 1L)
# Then, a quadratic one with fixed variance
quad0 <- basic
quad0$MODEL <- "i s q | W1@0.5 W2@1 W3@2 W4@4 W5@6 W6@9 W7@12 W8@18;
               q@0;"
result_quad0 <- mplusModeler(quad0, modelout = "quad0.inp", run = 1L)
# Combine them both in a list:
results <- list(result_linear, result_quad, result_quad0)
  covs <- quad0
# Add to the existing model
covs$MODEL <- c(covs$MODEL,
                "
                i s on TVLO;
                pain on i s; 
                MODEL male:
                i on TVLO (m1);
                s on TVLO (m2);
                pain on i (m3);
                pain on s (m4);
                MODEL female:
                i on TVLO (f1);
                s on TVLO (f2);
                pain on i (f3);
                pain on s (f4);")
# Add new usevariables:
covs$usevariables <- c(covs$usevariables, "tvlo", "gender", "pain")
covs$rdata
# Add grouping variable:
covs$VARIABLE <- "GROUPING IS gender (1 = male 2 = female);"
# Add parameter tests
covs$MODELTEST <- "m3 = f3; m4 = f4;"
                
result_covs <- mplusModeler(covs, modelout = "covs.inp", run = 1L)
})
```
```{r, echo = FALSE, results='markup'}
get_summaries(result_covs)
```

`r if(knitr::is_html_output()){"\\details"}`

#### Visualization

If you want to plot the model for these two groups, 
you can use the SEM graphing package `tidySEM`.
This flexible package produces fully customizable plots based on the R graphing package `ggplot2` for Mplus (and `lavaan`) models.
If you want to make publication quality graphs, [here is an online tutorial for graph customization](https://cjvanlissa.github.io/tidySEM/articles/Plotting_graphs.html).
The script below demonstrates how to plot a model using `tidySEM`. Assuming that we only want to visualize the regression part of the model, you could specify:

```{r demotidysem1, echo = TRUE, eval = TRUE}
library(tidySEM)
library(dplyr)
lo <- get_layout("",     "I",   "",
                 "TVLO", "",   "PAIN",
                 "",     "S",   "", rows = 3)
graph_sem(result_covs, layout = lo)
```

<!-- lo <- get_layout("PAIN",   "",   "",   "",   "",   "",   "",   "TVLO", -->
<!--                  "I",      "",   "",   "S",  "",   "",   "",   "Q", -->
<!--                  "W1",     "W2", "W3", "W4", "W5", "W6", "W7", "W8", rows = 3) -->
<!-- prepare_graph(result_covs, layout = lo) %>% -->
<!--   hide_var() %>% -->
<!--   plot() -->

#### Tabulating results

In addition to graphing, it is also possible to tabulate the results using `tidySEM`.
Here is a brief example:

```{r, echo = TRUE, eval = FALSE}
# Get all columns of results
tab <- table_results(result_covs, columns = NULL)
# Retain regression parameters
tab <- tab[tab$op == "~", ]
# Remove group name from the label
tab$label <- gsub("\\.(FE)?MALE", "", tab$label)
# Make a wide table with both groups next to each other
tab <- reshape(tab,
               timevar = "group",
               idvar = "label",
               direction = "wide")
# Retain only the standardized estimate, pvalue, and 95% CI
tab[, c(1, grep("(est_sig|pval|confint)_std", names(tab)))]
```

```{r 1b_make_table_hidden, eval = TRUE, echo = FALSE, results = "asis"}
# Get all columns of results
tab <- table_results(result_covs, columns = NULL)
# Retain regression parameters
tab <- tab[tab$op == "~", ]
# Remove group name from the label
tab$label <- gsub("\\.(FE)?MALE", "", tab$label)
# Make a wide table with both groups next to each other
tab <- reshape(tab, timevar = "group", idvar = "label", direction = "wide")
# Retain only columns with the standardized estimate, pvalue, and 95% CI
row.names(tab) <- NULL
kbl(tab[, c(1, grep("(est_sig|pval|confint)_std", names(tab)))], digits = 2)
```

## Exercise 2: Alcohol use 

The figure below depicts the basic Latent Growth model for the alcohol use data from Duncan, Duncan & Strycker example 8_1.

![Latent Growth model for alcohol](./Materials/Figure1_lgm_alcohol.png){width=400px}

The data are in the file `DDS8_1.dat`, with variables ALC1YR1 ALC1YR2 ALC1YR3 ALCPROB5 AGE1 and 
GENDER1. Missing values are coded as -99. The variable ALCPROB5 is categorical, it indicates alcohol problems in 
year 5 of the study (0=no, 1=yes).

First, load the file `DDS8_1.dat` into the R environment. For convenience's sake, rename the columns of the data object to something a human would understand:

```{r read_dataalc, echo = TRUE, eval = TRUE}
data <- read.table("DDS8_1.dat", na.strings = -99)
names(data) <- c("ALC1YR1", "ALC1YR2", "ALC1YR3",
                 "ALCPROB5", "AGE1", "GENDER1")
```

### Exercise 2a

Set up the growth curve model as depicted in the Figure in Mplus.
As a starting point, use the `MplusAutomation` code below.

* Add the necessary syntax statements to finalize the syntax.
* Request sample statistics and standardized (STDYX) output. 
* Inspect the output carefully with special attention for 
    1. the pattern of missing values
    2. how well the model fits
    3. interpretation of the output; how well does the model predict alcohol use over the 
years?

```{r, echo = TRUE, eval = FALSE}
m0 <- mplusObject(
  TITLE = "LGA MODEL",
  MODEL = "",
  OUTPUT = "",
  rdata = data,
  usevariables = c("ALC1YR1", "ALC1YR2", "ALC1YR3"))
```

<details>
  <summary><b>Click to show answers</b></summary>

Here is an example of how to approach the problem:


```{r}
m0 <- mplusObject(
  TITLE = "LGA MODEL",
  MODEL = "i s | ALC1YR1@0 ALC1YR2@1 ALC1YR3@2;",
  OUTPUT = "SAMPSTAT standardized;",
  PLOT = "SERIES = ALC1YR1 ALC1YR2 ALC1YR3 (s);
	        TYPE = PLOT3;",
  rdata = data,
  usevariables = c("ALC1YR1", "ALC1YR2", "ALC1YR3"))
```

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 2b

We will now *explore* how different predictor variables affect the model fit. 
Include gender and age in the model as predictors of the intercept and slope. Interpret the fit of the model 
and the output. 
Feel free to estimate several models, including or excluding certain covariates.
Either make a model fit table by hand in a spreadsheet, or use `SummaryTable()` to request the fit indices you deem to be appropriate.
Which model do you consider to be best?

#### Exploratory vs confirmatory research

Note that when you conduct *confirmatory* research, and are testing theoretical hypotheses, you should not add and omit paths based on exploratory analyses and model fit.

It is fine to add and remove paths in *exploratory* research. Model fit indices, like AIC and BIC, are suitable for selecting well-fitting models in exploratory research. P-values are not designed for variable selection, and using them for that purpose may lead to suboptimal models.

It is good scientific practice to clearly separate confirmatory and exploratory research. When you conduct exploratory research, you should not perform inference on the resulting parameters based on p-values (because inference generalizes your findings to the population, and exploratory findings tend to be tailored toward this specific sample).
You should also not present exploratory results as if they were testing a post-hoc theory ("Hypothesizing After the Results are Known", or HARKing, is a questionable research practice and can lead to false-positive (spurious) findings.

<details>
  <summary><b>Click to show answers</b></summary>

The answers to Exercise 1a demonstrate how to approach this.
Estimate multiple slightly different models, put them in a list, and run `SummaryTable()`.
Then use the AIC and BIC to identify the best-fitting model,
and assess how different the model fits are.
Also consider using RMSEA, CFI, TLI, and SRMR to make sure that your best-fitting
model has acceptable objective fit.

```{r}
# Create a vector with three "additional syntaxes"
# for my three different models
mod = c("i s ON GENDER1;",
        "i s ON AGE1;",
        "i s ON AGE1 GENDER1;",
        "i ON GENDER1;",
        "i ON AGE1;",
        "i ON AGE1 GENDER1;",
        "s ON GENDER1;",
        "s ON AGE1;",
        "s ON AGE1 GENDER1;",
        "i WITH s@0;",
        "!baseline")
# Create a list with the additional usevariables
# used in the three models above
vars = list("GENDER1",
            "AGE1",
            c("GENDER1", "AGE1"),
            "GENDER1",
            "AGE1",
            c("GENDER1", "AGE1"),
            "GENDER1",
            "AGE1",
            c("GENDER1", "AGE1"),
            NULL,
            NULL)
# Make a list of exploratory models by modifying m0
models <- lapply(1:length(mod), function(i){
  # append element i of mod
  m0$MODEL <- paste0(m0$MODEL, mod[i]) 
  # append element i of vars
  m0$usevariables <- c(m0$usevariables, vars[[i]])
  # Add unique filename
  m0$modelout = paste0("Model", i, ".inp") 
  # return the modified model
  m0 
})
# Run all models and store results in a list called results
results <- lapply(models, mplusModeler, run = 1L)
# Get summary table and store it in 'tab'
tab <- SummaryTable(results, 
                    keepCols = c("Parameters", "AIC", "BIC",
                                 "RMSEA_Estimate", "CFI",
                                 "TLI", "SRMR"),
                    sortBy = NULL)
# Order by BIC
tab <- tab[order(tab$BIC), ]
# Add model syntax to the table
tab <- cbind(Model = mod, tab)
tab
```
```{r 2b_make_table_hidden, echo = FALSE, results = "asis"}
row.names(tab) <- NULL
kbl(tab, digits = 2)
```

```{r}
# Plot the BICs and annotate with the syntax to see which is best
library(ggplot2)
qplot(x = 1:11, y = tab$BIC) +
  geom_line() +
  geom_text(label = tab$Model, size = 2)

```

It looks like, paradoxically, predicting I and S from either age or gender
has the best fit. However, note that there is only a small difference between
the smallest and the largest BIC: diff(range(tab$BIC)).
I would either go for the simplest model (i WITH s@0), or go for the
best-fitting model (i s ON GENDER1).

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 2c

Include alcohol problems in year 5 in the model: let the intercept and slope factors predict alcohol problems year 5. Declare the variable as categorical in the variable section (CATEGORICAL = ALCPROB5). 
Inspect if the effect of age and gender on alcohol problems year 5 is completely mediated by the growth 
factors, or if there are additional direct paths from age and gender on the alcohol problems. 


<details>
  <summary><b>Click to show answers</b></summary>

To test whether there is full mediation or not, we want to test whether the direct
effects are equal to zero or not.

If the analysis had not included a categorical dependent variable,
then we would have been able to compute the difference test using MplusAutomation's
function `compareModels(model1, model2, diffTest = TRUE)`.

However, in the presence of a categorical dependent variable, we must use Mplus'
option `difftest`.

Again, we can start from m0:

```{r}
# Specify model with only indirect effects
m2c_indirect <- m0
m2c_indirect$usevariables <- c(
  m2c_indirect$usevariables,
  "AGE1", "GENDER1", "ALCPROB5")
m2c_indirect$VARIABLE <- "CATEGORICAL = ALCPROB5;"
m2c_indirect$MODEL <- paste0(
  m0$MODEL,
  "i on AGE1 GENDER1;
  i WITH s;
  ALCPROB5 on i s;
  ALCPROB5 on AGE1 GENDER1;")
m2c_indirect$SAVEDATA <- "difftest is mediation.dat;"
m2c_indirect$modelout <- "m2c_indirect.inp"
# Run all models and store results in a list called results
result_ind <- mplusModeler(m2c_indirect, run = 1L)

# Specify model with direct effects too
m2c_direct <- m2c_indirect
# Constrain direct effects to 0 using gsub (replace)
m2c_direct$MODEL <- gsub("ALCPROB5 on AGE1 GENDER1;",
                         "ALCPROB5 on AGE1 GENDER1@0;",
                         m2c_direct$MODEL,
                         fixed = TRUE)
m2c_direct$ANALYSIS <- "difftest = mediation.dat;" 
m2c_direct$modelout <- "m2c_direct.inp"
# Run the direct model, which includes the difference test
result_dir <- mplusModeler(m2c_direct, run = 1L)
# Look at the model summaries
get_summaries(result_dir)
```
```{r 2c_make_table_hidden, echo = FALSE, results='markup'}
get_summaries(result_dir)
# kable_styling(knitr::kable(get_summaries(result_dir), digits = 2, format = "html"), latex_options = c("striped", "scale_down"))
```


Note that the ChiSqDiffTest_PValue is non-significant, which means we can
prefer the simpler (no direct effects) model. There is full mediation.

Let's use a graph to examine the unconstrained model too:

```{r}
lo <- get_layout("AGE1",    "", "",
                 "",        "I",  "ALCPROB5",
                 "GENDER1", "", "", rows = 3)
graph_sem(result_ind, layout = lo)
```

`r if(knitr::is_html_output()){"\\details"}`

## Exercise 3: Level and Shape Parameterization 

The file GPA.dat holds the GPA data (GPA = grade point average) with GPA scores of 200 students in 6 consecutive 
semesters. There are also time-invariant covariates: high school GPA and gender; and the outcome variable: 
admitted to university of choice (missing if not applied for university). Use the GPA data to set up a level and shape 
model.

First, load the data and name the variables:

```{r read_datagpa, echo = TRUE, eval = TRUE}
data <- read.table("GPA.dat")
names(data) <- c("STUDENT", "SEX", "HIGHGPA",
                 "GPA1", "GPA2", "GPA3", "GPA4", "GPA5", "GPA6")
```

### Exercise 3a

Use a parameterization with GPA1@0 and GPA6@1. The loadings for the other timepoints should be freely estimated. This can 
be done with, for example, the syntax GPA2* as shown in the handout.  
Interpret the factor loadings and estimate for S.  

<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows:

```{r}
m3 <- mplusObject(
  MODEL = "i s | gpa1@0 gpa2* gpa3* gpa4* gpa5* gpa6@1;",
  rdata = data,
  usevariables = c("GPA1", "GPA2", "GPA3", "GPA4", "GPA5", "GPA6"),
  modelout = "m3.inp"
)

res <- mplusModeler(m3, run = 1L)

# Get all columns of results
tab <- table_results(res, columns = NULL)
# Retain factor loadings and intercepts using op %in% c("=~", "~1") 
# for all parameters involving S (lhs == "S")
tab <- tab[tab$lhs == "S" & tab$op %in% c("=~", "~1"), ]
tab[, c("label", "est_sig", "pval", "confint")]
```

```{r, echo = FALSE, results = "asis"}
row.names(tab) <- NULL
kbl(tab[, c("label", "est_sig", "pval", "confint")], digits = 2)
```

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 3b

Now use a parameterization with GPA1@0 and GPA2@1. The other GPA’s should be freely estimated. 
Interpret the factor loadings and estimate for S.  

<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows:

```{r}
m3b <- m3 
m3b$MODEL <- "i s | gpa1@0 gpa2@1 gpa3* gpa4* gpa5* gpa6*;"

res_3b <- mplusModeler(m3b, run = 1L)

# Get all columns of results
tab <- table_results(res_3b, columns = NULL)
# Retain factor loadings and intercepts using op %in% c("=~", "~1") 
# for all parameters involving S (lhs == "S")
tab <- tab[tab$lhs == "S" & tab$op %in% c("=~", "~1"), ]
tab[, c("label", "est_sig", "pval", "confint")]
```

```{r, echo = FALSE, results = "asis"}
row.names(tab) <- NULL
kbl(tab[, c("label", "est_sig", "pval", "confint")])
```

`r if(knitr::is_html_output()){"\\details"}`

Which parameterization do you like best?

### Exercise 3c

Draw the development of GPA over time based on your own calculations (by hand).
Compare this to the estimated means plot that you can get with the plot command: 
PLOT: SERIES = GPA1-GPA6 (s); 
TYPE = PLOT3;  
However, don’t forget that you need to ‘rescale’ that plot, since S is linear while the location of the 
estimated points is based on the factor loadings.

<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows. Note that you will have to load the plot in Mplus:

```{r}
m3b$PLOT <- "SERIES = GPA1-GPA6 (s);
             TYPE = PLOT3;"

res_3b <- mplusModeler(m3b, run = 1L)
```

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 3d

Use sex as a predictor of the intercept and slope and interpret the result (with 0 = boys, 1 = girls). 


<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows:

```{r}
m3_sex <- m3
# Make 0 = boys and 1 = girls
m3_sex$rdata$SEX <- m3_sex$rdata$SEX - 1
m3_sex$usevariables <- c(m3_sex$usevariables, "SEX")
m3_sex$MODEL <- paste0(m3_sex$MODEL, "i s on sex;")
res_3sex <- mplusModeler(m3_sex, run = 1L)
# Get all columns of results
tab <- table_results(res_3sex, columns = NULL)
# Retain only regressions on I and S
tab <- tab[tab$lhs %in% c("I", "S") & tab$op == "~", ]
tab[, c("label", "est_sig", "pval", "confint")]
```

```{r, echo = FALSE, results = "asis"}
row.names(tab) <- NULL
kbl(tab[, c("label", "est_sig", "pval", "confint")])
```

`r if(knitr::is_html_output()){"\\details"}`

## Exercise 4: latent growth model on GPA data 

### Exercise 4a 

Continuing with the data used for the previous exercise, set up a latent growth model for GPA for the 6 consecutive occasions and run this model. Obtain the following parameters:

* AIC/BIC, Chi Square, RMSEA, CFI/TLI 
* Mean Intercept and Slope
* Variance of the Intercept and Slope


<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows, using m3 as starting point:

```{r}
m4 <- m3
m4$MODEL <- "i s | gpa1@0 gpa2@1 gpa3@2 gpa4@3 gpa5@4 gpa6@5;"
m4$modelout <- "m4.inp"
res_4 <- mplusModeler(m4, run = 1L)
# Get the requested fit indices:
get_summaries(res_4)[c("AIC", "BIC", "ChiSqM_Value",
                       "RMSEA_Estimate", "CFI", "TLI")]
# Get all columns of results
tab <- table_results(res_4, columns = NULL)
# Retain only regressions on I and S
tab <- tab[tab$lhs %in% c("I", "S") & tab$op %in% c("~~", "~1"), ]
tab[, c("label", "est_sig", "pval", "confint")]
```

```{r, echo = FALSE, results = "asis"}
invisible({
  m4 <- m3
m4$MODEL <- "i s | gpa1@0 gpa2@1 gpa3@2 gpa4@3 gpa5@4 gpa6@5;"
m4$modelout <- "m4.inp"
res_4 <- mplusModeler(m4, run = 1L)
# Get the requested fit indices:
})
get_summaries(res_4)[c("AIC", "BIC", "ChiSqM_Value",
                       "RMSEA_Estimate", "CFI", "TLI")]
# Get all columns of results
tab <- table_results(res_4, columns = NULL)
# Retain only regressions on I and S
tab <- tab[tab$lhs %in% c("I", "S") & tab$op %in% c("~~", "~1"), ]
row.names(tab) <- NULL
kbl(tab[, c("label", "est_sig", "pval", "confint")])
```

`r if(knitr::is_html_output()){"\\details"}`

### Exercise 4b

Then, set up a latent growth model for 3 years where each year is a latent variable measured by the GPA of two 
consecutive semesters. 

The factor loadings for GPA2, GPA4 and GPA6 ought to be constrained to be equal with a label (a) behind 
the loading in the syntax. As such, the scores relate in the same way to the year score over time. The GPA 
intercepts are constrained at 0.  

If you get the error message below, can you find out what the problem is?  

```
WARNING:  THE LATENT VARIABLE COVARIANCE MATRIX (PSI) IS NOT POSITIVE     DEFINITE. THIS 
COULD INDICATE A NEGATIVE VARIANCE/RESIDUAL VARIANCE FOR A LATENT VARIABLE, A CORRELATION 
GREATER OR EQUAL TO ONE BETWEEN TWO LATENT VARIABLES, OR A LINEAR DEPENDENCY AMONG MORE 
THAN TWO LATENT VARIABLES. CHECK THE TECH4 OUTPUT FOR MORE INFORMATION. 
```

A rough way to deal with this problem may be to fix the problematic parameter to a particular value (ie. .001), try this and re-run the model.  

Now examine the same parameters as for exercise 3a, and compare the two. Are there 
major differences? 

* AIC/BIC, Chi Square, RMSEA, CFI/TLI 
* Mean Intercept and Slope
* Variance of the Intercept and Slope

<details>
  <summary><b>Click to show answers</b></summary>

This can be done as follows, using m3 as starting point:

```{r}
m4b <- m4
m4b$MODEL <- "year1 by gpa1@1 gpa2 (a);
             year2 by gpa3@1 gpa4 (a); 
             year3 by gpa5@1 gpa6 (a);
             [gpa1@0 gpa2@0 gpa3@0 gpa4@0 gpa5@0 gpa6@0];
             i s | year1@0 year2@1 year3@2;
             [i s];
             year3@.001;"
res_4b <- mplusModeler(m4b, run = 1L)
# Get the requested fit indices:
get_summaries(res_4b)[c("AIC", "BIC", "ChiSqM_Value",
                        "RMSEA_Estimate", "CFI", "TLI")]
# Get all columns of results
tab <- table_results(res_4b, columns = NULL)
# Retain only regressions on I and S
tab <- tab[tab$lhs %in% c("I", "S") & tab$op %in% c("~~", "~1"), ]
tab[, c("label", "est_sig", "pval", "confint")]
```

```{r, echo = FALSE, results = "asis"}
suppressMessages(invisible({
m4b <- m4
m4b$MODEL <- "year1 by gpa1@1 gpa2 (a);
             year2 by gpa3@1 gpa4 (a); 
             year3 by gpa5@1 gpa6 (a);
             [gpa1@0 gpa2@0 gpa3@0 gpa4@0 gpa5@0 gpa6@0];
             i s | year1@0 year2@1 year3@2;
             [i s];
             year3@.001;"
res_4b <- mplusModeler(m4b, run = 1L)
# Get the requested fit indices:

}))
get_summaries(res_4b)[c("AIC", "BIC", "ChiSqM_Value", "RMSEA_Estimate", "CFI", "TLI")]
# Get all columns of results
tab <- table_results(res_4b, columns = NULL)
# Retain only regressions on I and S
tab <- tab[tab$lhs %in% c("I", "S") & tab$op %in% c("~~", "~1"), ]
row.names(tab) <- NULL
kbl(tab[, c("label", "est_sig", "pval", "confint")])
```

`r if(knitr::is_html_output()){"\\details"}`
